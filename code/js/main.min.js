var stageNames = ["Battlefield","Final Destination","Delfino's Secret","Luigi's Mansion","Metal Cavern","Bowser's Castle","Kongo Jungle","Rumble Falls","Pirate Ship","Hyrule Castle","Norfair","Frigate Orpheon","Yoshi's Island (Brawl)","Halberd","Lylat Cruise","Saffron City","Spear Pillar","Port Town Aero Dive","Infinite Glacier","Flat Zone 2","Castle Siege","Wario Land","Distant Planet","Skyworld","Fountain of Dreams","Fourside","Smashville","Shadow Moses Island","Green Hill Zone","PictoChat","Hanenbow","Temple","Yoshi's Story (Melee)","Jungle Japes","Onett","Dreamland","Peach's Castle 64","Corneria","Big Blue","Brinstar","Pok√©mon Stadium 2","Training Room"];

var stageIDs =["battlefield","final-destination","delfinos-secret","luigis-mansion","metal-cavern","bowsers-castle","kongo-jungle","rumble-falls","pirate-ship","hyrule-castle","norfair","frigate-orpheon","yoshis-island-brawl","halberd","lylat-cruise","saffron-city","spear-pillar","port-town-aero-dive","infinite-glacier","flat-zone-2","castle-siege","wario-land","distant-planet","skyworld","fountain-of-dreams","fourside","smashville","shadow-moses-island","green-hill-zone","pictochat","hanenbow","temple","yoshis-story-melee","jungle-japes","onett","dreamland","peachs-castle-64","corneria","big-blue","brinstar","pokemon-stadium-2","training-room"];

var defaultStages = [["15", "18", "01", "23", "1C", "1A", "00", "28", "02"],
["15", "18", "01", "0C", "23", "1C", "1A", "00", "28", "02"],
["15", "18", "01", "0C", "16", "23", "1C", "1A", "00", "28", "02"],
["14", "15", "18", "01", "0C", "16", "23", "1C", "1A", "00", "28", "02"],
["15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["0A", "0E", "17", "14", "15", "18", "01", "0C", "16", "20", "1C", "1A", "00", "28", "02"],
["07", "0A", "0E", "17", "14", "15", "18", "01", "0C", "16", "20", "1C", "1A", "00", "28", "02"],
["04", "07", "0A", "0E", "17", "14", "15", "18", "01", "0C", "16", "20", "1C", "1A", "00", "28", "02"],
["1D", "04", "07", "0A", "0E", "17", "14", "15", "18", "01", "0C", "16", "20", "1C", "1A", "00", "28", "02"],
["06", "1D", "04", "07", "0A", "0E", "17", "14", "15", "18", "01", "0C", "16", "20", "1C", "1A", "00", "28", "02"],
["05", "06", "1D", "04", "07", "0A", "0E", "17", "14", "15", "18", "01", "0C", "16", "20", "1C", "1A", "00", "28", "02"],
["0E", "09", "04", "05", "0F", "24", "12", "14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["17", "0E", "09", "04", "05", "0F", "24", "12", "14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["06", "17", "0E", "09", "04", "05", "0F", "24", "12", "14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["1D", "06", "17", "0E", "09", "04", "05", "0F", "24", "12", "14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["0D", "1D", "06", "24", "0E", "09", "04", "05", "0F", "24", "12", "14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["0B", "0D", "1D", "06", "24", "0E", "09", "04", "05", "0F", "24", "12", "14", "15", "18", "01", "0C", "16", "0A", "20", "1C", "1A", "00", "28", "02", "23"],
["24", "06", "19", "22", "26", "11", "08", "03", "1D", "25", "27", "1F", "12", "10", "0F", "09", "0D", "0B", "16", "07", "0E", "20", "05", "04", "0C", "0A", "17"]
];

var stageRows = [[0,4,5], [0,5,5], [0,6,5], [0,7,5], [0,6,7], [0,7,7], [5,5,5], [6,5,5], [6,6,5], [7,6,5], [7,7,5], [7,6,7], [7,7,7], [8,7,7], [8,8,7], [9,8,7], [9,9,7], [9,8,9], [9,9,9]];
$(document).ready(function() {
	var page1Amount = 9;
	var page2Amount = 27;
	var removeStg;
	var removeFromGrid;
	var a;
	var ab;
	var ia;
	var myGct = new Blob();
	var reader = new FileReader();
	var startDrag=false;
	var grids = [];
	var xPos;
	var yPos;

	grids[0] = new Muuri('#stagelist-icons-page1-row1', {
		dragEnabled: true,
		dragSort: function () {
			return [grids[0], grids[1], grids[2], grids[3], grids[4], grids[5]]
		  }
	}).on('receive', function (data) {dragStage(data)});

	grids[1] = new Muuri('#stagelist-icons-page1-row2', {
		dragEnabled: true,
		dragSort: function () {
			return [grids[0], grids[1], grids[2], grids[3], grids[4], grids[5]]
		  }
	}).on('receive', function (data) {dragStage(data)});;

	grids[2] = new Muuri('#stagelist-icons-page1-row3', {
		dragEnabled: true,
		dragSort: function () {
			return [grids[0], grids[1], grids[2], grids[3], grids[4], grids[5]]
		  }
	}).on('receive', function (data) {dragStage(data)});

	grids[3] = new Muuri('#stagelist-icons-page2-row1', {
		dragEnabled: true,
		dragSort: function () {
			return [grids[0], grids[1], grids[2], grids[3], grids[4], grids[5]]
		  }
	}).on('receive', function (data) {dragStage(data)});

	grids[4] = new Muuri('#stagelist-icons-page2-row2', {
		dragEnabled: true,
		dragSort: function () {
			return [grids[0], grids[1], grids[2], grids[3], grids[4], grids[5]]
		  }
	}).on('receive', function (data) {dragStage(data)});

	grids[5] = new Muuri('#stagelist-icons-page2-row3', {
		dragEnabled: true,
		dragSort: function () {
			return [grids[0], grids[1], grids[2], grids[3], grids[4], grids[5]]
		  }
	}).on('receive', function (data) {dragStage(data)});

	$("#btn-reset-page-1").click(function(e){
		e.preventDefault();
		grids[0].remove(grids[0].getItems(), {removeElements: true});
		grids[1].remove(grids[1].getItems(), {removeElements: true});
		grids[2].remove(grids[2].getItems(), {removeElements: true});
		$("#stagelist-icons-page1-row1").hide();
		page1Amount = 9;
		populateIcons("-page1", 9);
		addListeners();
	});
	$("#btn-reset-page-2").click(function(e){
		e.preventDefault();
		grids[3].remove(grids[3].getItems(), {removeElements: true});
		grids[4].remove(grids[4].getItems(), {removeElements: true});
		grids[5].remove(grids[5].getItems(), {removeElements: true});
		page2Amount = 27;
		populateIcons("-page2", 27);
		addListeners();
	});
	$("#btn-add-stage-page-1").click(function(e){
		e.preventDefault();
		if(page1Amount<27){
			page1Amount++;
			addStage([grids[0],grids[1],grids[2]], "-page1", page1Amount);
		}
	});
	$("#btn-add-stage-page-2").click(function(e){
		e.preventDefault();
		if(page2Amount<27){
			page2Amount++;
			addStage([grids[3],grids[4],grids[5]], "-page2", page2Amount);
		}
	});
	
	$("#generate_codes").click(function(e) {
		e.preventDefault();
  		var demcodes = "<br />Custom Stage Select Screen [Spunit, Phantom Wings, SOJ]<br /><br />* 046B8F5C 7C802378<br />* 046B8F64 7C6300AE<br />* 040AF618 5460083C<br />* 040AF68C 38840002<br />* 040AF6AC 5463083C<br />* 040AF6C0 88030001<br />* 040AF6E8 3860FFFF<br />* 040AF59C 3860000C<br />* 060B91C8 00000018<br />* BFA10014 7CDF3378<br />* 7CBE2B78 7C7D1B78<br />* 2D05FFFF 418A0014";
		demcodes+=generateCode().toUpperCase();
		demcodes+="<br />* 06407AAC 00000058<br />* 01010202 03030404<br />* 05050606 07070808<br />* 0909330A 0B0B0C0C<br />* 0D0D0E0E 130F1410<br />* 15111612 17131814<br />* 19151C16 1D171E18<br />* 1F19201A 211B221C<br />* 231D241E 251F2932<br />* 2A332B34 2C352D36<br />* 2F373038 3139323A<br />* 2E3B0064 0707373C";
		$("#demCodes").html(demcodes);
		if($('#demCodes:hidden')) $("#demCodes").slideToggle("slow");
	});

	$("#btn-delete_stage").click(function(e){
		e.preventDefault();
		if(removeFromGrid < 3 && page1Amount > 9){
			page1Amount--;
			removeStage([grids[0],grids[1],grids[2]], "-page1", page1Amount);
		}else if(removeFromGrid >= 3 && page2Amount > 9){
			page2Amount--;
			removeStage([grids[3],grids[4],grids[5]], "-page2", page2Amount);
		}
	});

	$('#stage-picker').change(function(){
		console.log($(this).val());
		$(removeStg[0].firstChild).attr('class', 'modal '+$(this).val());
		$(removeStg[0].firstChild).attr('name', $("#stage-picker option[value='"+$(this).val()+"']").text());
		$(removeStg[0].firstChild.firstChild).attr('src', "code/images/stages/MenSelmapIcon."+$(this).val().split(' ')[0]+".png");
	});
	
	$('#gct_upload').change(function(){
		var curFiles = this.files;
		var myGct = curFiles[0].slice();
		reader.readAsArrayBuffer(myGct);
	});

	$('#load-gct').click(function(e){
		e.preventDefault();
	})

	$('#saveGct').click(function(e){
		e.preventDefault();
		ab = new ArrayBuffer((a.length)/2);
		ia = new Uint8Array(ab);
		var j = 0;
		for (var i = 0; i < a.length; i+=2) {
			ia[j] = parseInt(("0x"+a[i]+a[i+1]));
			j++;
		}
		var blob = new Blob([ia], {type: "GCT file"});
		saveAs(blob, "RSBE01.gct");
	});

	reader.addEventListener("loadend", function() {
		var u = new Uint8Array(this.result),
		a = "";
		for(i=0; i<u.length; i++)
			a+= (u[i] < 16 ? '0' : '') + u[i].toString(16).toUpperCase();
		u = null;
		saveGct(a);
	});

	function saveGct(gctString){
		a = gctString;
		$("#modal-load-gct").modal();
	}

	function dragStage(data){
		if(!startDrag){
			startDrag = true;
			var items = data.toGrid.getItems();
			for(i=0;i<items.length;i++){
				if(items[i]._id == data.item._id){
					if(items[i+1]) data.toGrid.send((i+1),data.fromGrid,0);
					else data.toGrid.send((i-1),data.fromGrid,0);
				}
			}
			startDrag = false;
		}
	}

	populateIcons("-page1", page1Amount);
	populateIcons("-page2", page2Amount);
	addListeners();
	generateCode();

	function addListeners(){
		$('.modal').off();
		$('.modal').on('mousedown', function (e) {
			e.preventDefault();
			xPos = e.clientX;
			yPos = e.clientY;
		});
		$('.modal').on('mouseup', function (e) {
			e.preventDefault();
			if(xPos == e.clientX && yPos == e.clientY){
				if($(this).parent().parent()[0].id[20] ==1){
					removeFromGrid = $(this).parent().parent()[0].id[25]-1;
				}else{
					removeFromGrid = parseInt($(this).parent().parent()[0].id[25])+2;
				}
				removeStg = $(this).parent();
				$('#modal-advanced_mode .module-header').html($(this).attr("name"));
				$('#stage-picker').val($(this)[0].className.split(' ')[1]+" "+$(this)[0].className.split(' ')[2]);
				$("#modal-advanced_mode").modal();
			}
		});
		$('.modal').on('click', function(e){
			e.preventDefault();
		});
	}
	
	function populateIcons(page, stageAmount){
		console.log('yellow?');
		var stgIcons=[];
		var itemElem = document.createElement('div');
		var rowAmount = stageAmount-9;
		var curStg = 1;
		for(i=0; i<3; i++){
			stgIcons=[];
			itemElem = document.createElement('div');
			if(stageRows[rowAmount][i] == 0){
				$("#stagelist-icons"+page+"-row1").hide();
				continue;
			}
			for(stg=1; stg<=stageRows[rowAmount][i]; stg++){
				temp="";
				x=parseInt((defaultStages[rowAmount][curStg-1]),16)+1;
				if (x<10) x = "0"+x;
				if (x>31) x=parseInt(x)+18;
				console.log(parseInt((defaultStages[rowAmount][curStg-1]),16)+1);
				if($("#coloredStagelists").is(':checked')) temp+="<div class='item'><img class='item-content' src='"+colorStages(page,curStg);
				else{ temp+='<div class="item"><a href="#" name="'+stageNames[parseInt((defaultStages[rowAmount][curStg-1]),16)]+'"';
				temp+=" class='modal "+x+" "+defaultStages[rowAmount][curStg-1]+"'><img class='item-content' src='code/images/stages/MenSelmapIcon."; }
				temp+=x+".png' id='stage-icon-"+curStg+page+"' width='75' height='66'></a></div>";
				itemElem.innerHTML = temp;
				stgIcons.push(itemElem.firstChild);
				curStg++;
			}
			$("#stagelist-icons"+page+"-row"+(i+1)).width((stageRows[rowAmount][i])*85);
			if(page=="-page1"){
				grids[i].add(stgIcons);			
			}else{
				grids[i+3].add(stgIcons);
			}
		}
	}

	function addStage(stageGrids, page, stageAmount){
		//stgIcons is the current list of icon elements
		var stgIcons = [];
		var curStg = 0;
		var stgReplace = stageAmount-1;
		for(i=0; i<3; i++){ stageGrids[i].getItems().forEach(function(e){stgIcons.push(e.getElement())}); }
		loop1:
		for(i=0; i<stageAmount; i++){
			loop2:
			for(j=0; j<stgIcons.length; j++){
				temp = stgIcons[j].firstChild.className.split(' ')[2];
				if(temp.length == 1){ temp="0"+temp; }
				if(temp==defaultStages[stageAmount-9][i]){
					 continue loop1;
				}
			}
			stgReplace = i;
		}
		itemElem = document.createElement('div');
		x=parseInt((defaultStages[stageAmount-9][stgReplace]),16)+1;
		temp='<div class="item"><a href="#" name="'+stageNames[x-1]+'"';
		if (x<10) x = "0"+x;
		if (x>31) x=parseInt(x)+18;
		temp+=" class='modal "+x+" "+defaultStages[stageAmount-9][stgReplace]+"'><img class='item-content' src='code/images/stages/MenSelmapIcon.";
		temp+=x+".png' id='stage-icon-"+stageAmount+page+"' width='75' height='66'></a></div>";
		itemElem.innerHTML = temp;
		stgIcons.push(itemElem.firstChild);
		refreshStages(stageGrids, page, stageAmount, stgIcons);
	}

	function removeStage(stageGrids, page, stageAmount){
		grids[removeFromGrid].remove([removeStg[0]], {removeElements: true});
		var stgIcons = [];
		for(i=0; i<3; i++){ stageGrids[i].getItems().forEach(function(e){stgIcons.push(e.getElement())}); }
		refreshStages(stageGrids, page, stageAmount, stgIcons);
	}

	function refreshStages(stageGrids, page, stageAmount, stgIcons){
		var curStg = 0;
		for(i=0; i<3; i++){ stageGrids[i].remove(stageGrids[i].getItems(), {removeElements: true}) }
		for(i=0; i<3; i++){
			if(stageRows[stageAmount-9][i] == 0){
				$("#stagelist-icons"+page+"-row1").hide();
				continue;
			}else{ $("#stagelist-icons"+page+"-row1").show(); }
			for(stg=0; stg<stageRows[stageAmount-9][i]; stg++){
				stageGrids[i].add(stgIcons[curStg]);
				curStg++;
			}
			$("#stagelist-icons"+page+"-row"+(i+1)).width((stageRows[stageAmount-9][i])*85);
			stageGrids[i].layout();
		}
		addListeners();
	}
	
	function populatePickers(page){

		// var pickers="";
		// var defaultAmount = $("#stage-amount"+page).val()-9;
		// var x;
		// for(pckr=1; pckr<=$("#stage-amount"+page).val(); pckr++){
			
		// 	pickers+="<br /><br />Stage "+pckr+": <select style='width:160px' name='"+pckr+"' class='stage-picker"+page+"'>";
		// 	for(stgName=0; stgName<42; stgName++){
		// 		stgID=stgName+1;
		// 		if (stgID<10) stgID = "0"+stgID;
		// 		if (stgID>31) stgID=parseInt(stgID)+18;
		// 		pickers+="<option value='"+(stgID)+"'";
		// 		x=parseInt(defaultStages[defaultAmount][pckr-1],16);				
		// 		if(stgName==x || (x==43 && stgName==41)){
		// 			 pickers+=" selected";
		// 		}
		// 		pickers+=">"+stageNames[stgName]+"</option>";
		// 	}
		// 	pickers+="</select>";
		// }
		// $("#stgPicker"+page).html(pickers);
		
		// $(".stage-picker"+page).change(function() {
		// 	var stageval = $(this).val();
		// 	var stg = $(this).attr("name");
		// 	if($("#coloredStagelists").is(':checked')){
		// 		var stgsrc=colorStages(page,stg,0);
		// 		stgsrc+=stageval+".png";
		// 	}
		// 	else{ var stgsrc = "code/images/stages/MenSelmapIcon."+stageval+".png"; }
		// 	$("#stage-icon-"+$(this).attr("name")+page).attr("src", stgsrc);
		// });
		
	}

	//Generate Code
	function generateCode(){
				
		var stageAmountPage1 = ($("#stage-amount-page1").val());
		var stageAmountPage2 = ($("#stage-amount-page2").val());
		var page1Hex = parseInt(stageAmountPage1).toString(16);
		var page2Hex = parseInt(stageAmountPage2).toString(16);
		if(page1Hex.length == 1) page1Hex="0"+page1Hex;
		if(page2Hex.length == 1) page2Hex="0"+page2Hex;
		var stageCodes = "<br />* 006B929C 000000"+page1Hex+"<br />* 066B99D8 000000"+page1Hex+"<br />* ";
		
		//Get all the stage IDs
		for(stg=1; stg<=stageAmountPage1; stg++){
			hexIndex = parseInt($(".stage-picker-page1[name='"+stg+"']").val()-1);
			if (hexIndex>48) hexIndex=hexIndex-18;
			hexIndex=hexIndex.toString(16);
			if(hexIndex.length==1) stageCodes+="0";
			if(hexIndex=='29') hexIndex='2B';
			stageCodes+=hexIndex;
			if((stg%8)==0) stageCodes+="<br />* ";
			else if((stg%4)==0) stageCodes+=" ";
		}
		
		
		//Add Zeros
		if(stageAmountPage1%8 != 0){
			var addZeros = (8-(stageAmountPage1%8))*2;
			for(zeros=addZeros; zeros>0; zeros--){
				if(zeros==8 && addZeros!=8) stageCodes+=" ";
				stageCodes+="0";
		}}

		stageCodes+= "<br />* 006B92A4 000000"+page2Hex+"<br />* 066B9A58 000000"+page2Hex+"<br />* ";
		
		for(stg=1; stg<=stageAmountPage2; stg++){
			hexIndex = parseInt($(".stage-picker-page2[name='"+stg+"']").val()-1);
			if (hexIndex>48) hexIndex=hexIndex-18;
			hexIndex=hexIndex.toString(16);
			if(hexIndex.length==1) stageCodes+="0";
			if(hexIndex=='29') hexIndex='2B';
			stageCodes+=hexIndex;
			if((stg%8)==0) stageCodes+="<br />* ";
			else if((stg%4)==0) stageCodes+=" ";
		}
		
		//Add Zeros
		if(stageAmountPage2%8 != 0){
			var addZeros = (8-(stageAmountPage2%8))*2;
			for(zeros=addZeros; zeros>0; zeros--){
				if(zeros==8 && addZeros!=8) stageCodes+=" ";
				stageCodes+="0";
		}}
		
		if($("#coloredStagelists").is(':checked')){
			var stageTextures = "@echo off\r\ncopy /b baseFiles\\ miscData80\\ \r\n";
			var page="-page1";
			for(stg=1; stg<=$("#stage-amount"+page).val(); stg++){
				stageTextures+="\r\ncopy /b ";
				//projectm\pf\fighter\captain\ ssbb.d\files\fighter\captain\"
				stageTextures+=(colorStages(page, stg)+($(".stage-picker"+page+"[name='"+stg+"']").val())+".png").replace(/\//g, "\\");
				stageTextures+=" miscData80\\ \r\ncopy /b ";
				stageTextures+=(colorStages(page, stg, 1)+($(".stage-picker"+page+"[name='"+stg+"']").val())+".png").replace(/\//g, "\\");
				stageTextures+=" miscData80\\ ";
				if(stg==$("#stage-amount"+page).val() && page=="-page1"){ page="-page2"; stg=0; }
			}			
			
			var blob = new Blob([stageTextures], {type: "text/plain;charset=utf-8"});
			console.log(stageTextures);
			saveAs(blob, "stagelist Textures.bat");
		}
		
		return(stageCodes);
	}
	
	function colorStages(page, stg, portraits){
		var stageAmount = $("#stage-amount"+page).val();
		var stageRowNumber = stageAmount-9;
		if(page=="-page2"){
			 if(portraits==1) return "stagelistTextures/Banned/Portraits/MenSelmapPrevbase.";
			 return "stagelistTextures/Banned/Icons/MenSelmapIcon.";
		}
		else if(page=="-page1" && stg<=(stageRows[stageRowNumber][0]+stageRows[stageRowNumber][1])){
			if(portraits==1) return "stagelistTextures/Counterpick/Portraits/MenSelmapPrevbase.";
			return "stagelistTextures/Counterpick/Icons/MenSelmapIcon.";
		}
		else if(page=="-page1" && stg>(stageRows[stageRowNumber][0]+stageRows[stageRowNumber][1])){
			if(portraits==1) return "stagelistTextures/Starter/Portraits/MenSelmapPrevbase.";
			return "stagelistTextures/Starter/Icons/MenSelmapIcon.";
		}
	}
	// $("#stage-amount-page1").on('focus', function () {
    //     // Store the current value on focus and on change
    //     previous = this.value;
	// 	var hexIndex;
	// 	for(stg=1;stg<=previous;stg++){
	// 		hexIndex = parseInt($(".stage-picker-page1[name='"+stg+"']").val()-1);
	// 		if (hexIndex>48) hexIndex=hexIndex-18;
	// 		hexIndex=hexIndex.toString(16);
	// 		if(hexIndex.length==1) hexIndex="0"+hexIndex;
	// 		if(hexIndex=='29') hexIndex='2B';
	// 		defaultStages[previous-9][stg-1]=hexIndex;
	// 	}
    // }).change(function() {
    //     // Do something with the previous value after the change
	// 	// populatePickers("-page1");
	// 	grid1.remove();
	// 	grid2.remove();
	// 	grid3.remove();
	// 	populateIcons("-page1");
	// 	$('.modal').off('mousedown');
	// 	$('.modal').off('mouseup');
	// 	addListeners();
    // });
	
	// $("#stage-amount-page2").change(function () {
	// 	// populatePickers("-page2");
	// 	grid4.remove();
	// 	grid5.remove();
	// 	grid6.remove();
	// 	populateIcons("-page2");
	// 	$('.modal').off('mousedown');
	// 
});